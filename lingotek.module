<?php
/**
 * @file
 * Module core functionality.
 */

/**
 * Identifies a content type which has Lingotek translation enabled.
 */
define('LINGOTEK_ENABLED', 'lingotek');
define('LINGOTEK_VERSION', '7.x-1.62');

include_once('lingotek.session.inc');
include_once('lingotek.reference.inc');
include_once('lingotek.util.inc');
include_once('lingotek.api.inc');

/**
 * Implements hook_menu().
 */
function lingotek_menu() {
  $items = array();

  // Future Settings Tab
  $items['admin/settings/lingotek'] = array(
    'title' => 'Lingotek',
    'access arguments' => array('administration'),
    'description' => 'Community Translation Settings',
    'file' => 'lingotek.admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lingotek_admin_form'),
  );

  /*
  // Lingotek Dashboard and Settings Tabs
  $items['admin/settings/lingotek'] = array(
    'title' => 'Lingotek',
    'file' => 'lingotek.dashboard.inc',
    'page callback' => 'lingotek_dashboard',
    'weight' => 1,

    'type' => MENU_NORMAL_ITEM,
    'access arguments' => array('administration')
  );
  $items['admin/settings/lingotek/dashboard'] = array(  
    'title' => 'Dashboard',
    'type' => MENU_DEFAULT_LOCAL_TASK
  );
  // Tab:  Settings
  $items['admin/settings/lingotek/settings'] = array(
    'title' => 'Settings',
    'type' => MENU_LOCAL_TASK,
    'weight' => 5,
    'access arguments' => array('administration'),
    'description' => 'Community Translation Settings',
    'file' => 'lingotek.admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lingotek_admin_form'),
  );

  // Dashboard Ajax Command Processor
  $items['admin/settings/lingotek/command'] = array(
    'title' => 'Command Router',
    'type' => MENU_CALLBACK,
    'access arguments' => array('access content'),
    'description' => 'Lingotek Command Router',
    'file' => 'lingotek.dashboard.inc',
    'page callback' => 'lingotek_dashboard_command_ajax',
  );
  */
  /*
  // Tab:  Analytics
  $items['admin/settings/lingotek/analytics'] = array(
    'title' => 'Analytics',
    'type' => MENU_LOCAL_TASK,
    'weight' => 10,
    'file' => 'lingotek.dashboard.inc',
    'page callback' => 'lingotek_translate',
    'access arguments' => array('administration')
  );
  // Tab:  Statistics
  $items['admin/settings/lingotek/statistics'] = array(
    'title' => 'Stats',
    'type' => MENU_LOCAL_TASK,
    'weight' => 15,
    'file' => 'lingotek.dashboard.inc',
    'page callback' => 'lingotek_statistics',
    'access arguments' => array('administration')
  );
  // Tab:  Development
  $items['admin/settings/lingotek/development'] = array(
    'title' => 'Development',
    'type' => MENU_LOCAL_TASK,
    'weight' => 20,
    'file' => 'lingotek.dashboard.inc',
    'page callback' => 'lingotek_development',
    'access arguments' => array('administration')
  );
  */

  $items['node/%node/lingotek_pm'] = array(
    'title' => 'Lingotek',
    'access arguments' => array(1, 'pm'),
    'access callback' => 'lingotek_access',
    'file' => 'lingotek.page.inc',
    'page arguments' => array(1),
    'page callback' => 'lingotek_pm',
    'type' => MENU_LOCAL_TASK,
    'weight' => 3,
  );

  $items['lingotek/update'] = array(
    'access arguments' => array('pm'),
    'file' => 'lingotek.page.inc',
    'page callback' => 'lingotek_update',
    'type' => MENU_CALLBACK,
  );
  
  $items['lingotek/mark-phases-complete/%node'] = array(
    'access arguments' => array('access content'),
    'file' => 'includes/lingotek.ajax.inc',
    'page callback' => 'lingotek_page_mark_phases_complete',
    'page arguments' => array(2),
    'type' => MENU_CALLBACK,
  );

  /* // Adds a submenu item to the main lingotek menu item (that is only for node level content.).  This should be safe to remove.  Just commenting out for testing.
  $items['admin/settings/lingotek/dev'] = array(
    'title' => 'Lingotek Developer Tools',
    'access arguments' => array('dev'),
    'description' => 'Developer Tools',
    'file' => 'lingotek.dev.inc',
    'page callback' => 'lingotek_dev_page',
    'type' => MENU_LOCAL_TASK,
  );
  */

  $items['admin/config/regional/field-data-cleanup'] = array(
    'title' => 'Lingotek Field Data Cleanup Utility',
    'description' => 'Updates language settings for existing field data.',
    'access arguments' => array('access lingotek utilities'),
    'file' => 'lingotek.admin.inc',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('lingotek_form_field_language_utility'),
    'type' => MENU_NORMAL_ITEM,
  );

  $items['node/%node/lingotek_dev'] = array(
    'title' => 'Lingotek Developer Tools',
    'access arguments' => array('dev'),
    'description' => 'Developer Tools',
    'file' => 'lingotek.dev.inc',
    'page callback' => 'lingotek_dev_page',
    'page arguments' => array(1),
    'type' => MENU_LOCAL_TASK,
  );

  // Easy Install Screens ----------------------------------------

  // Setup Path Router
  $items[ 'admin/config/lingotek/setup' ] = array(
    'title' => 'Lingotek Setup Path Router',
    'description' => 'Figures out the necessary setup path.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  // New Account
  $items[ 'admin/config/lingotek/new-account' ] = array(
    'title' => 'Create a Lingotek Account',
    'description' => 'Setup a new Lingotek account.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup_new_account_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  // Current Users
  $items[ 'admin/config/lingotek/account-settings' ] = array(
    'title' => 'Lingotek Account Login',
    'description' => 'Manage your Lingotek account settings.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup_account_settings_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  $items[ 'admin/config/lingotek/community-select' ] = array(
    'title' => 'Choose Your Community',
    'description' => 'Select a community to use with this site.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_community_select_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  $items[ 'admin/config/lingotek/project-select' ] = array(
    'title' => 'Choose Your Project',
    'description' => 'Select project to use.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_project_select_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  // Standard Screens
  $items[ 'admin/config/lingotek/language-settings' ] = array(
    'title' => 'Choose Your Languages',
    'description' => 'Manage your Lingotek language settings.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup_language_settings_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  $items[ 'admin/config/lingotek/node-translation-settings' ] = array(
    'title' => 'Enable Content Types',
    'description' => 'Select the nodes and fields you want translated.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup_node_translation_settings_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );
  $items[ 'admin/config/lingotek/content-type-choose-fields-ajax/%' ] = array(
    'title' => 'Content Types Ajax',
    'description' => 'Ajax functionality for content options.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'lingotek_content_type_choose_fields_callback',
    'page arguments' => array(4),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  $items[ 'admin/config/lingotek/setup-complete' ] = array(
    'title' => 'Setup Complete',
    'description' => 'Your Lingotek module has been configured and is now ready to use.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup_complete_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  $items[ 'admin/config/lingotek/node-updates' ] = array(
    'title' => 'Lingotek Node Updates',
    'description' => 'Updates your nodes to support multiple languages.',
    'file' => 'lingotek.setup.inc',    
    'page callback' => 'drupal_get_form',
    'page arguments' => array( 'lingotek_setup_node_updates_form' ),
    'type' => MENU_CALLBACK,
    'access arguments' => array('administration')
  );

  return $items;
}

/**
 * Implements hook_menu_alter().
 */
function lingotek_menu_alter(&$items) {
  // If the Entity Translation module is enabled alongside Lingotek,
  // allow nodes that haven't yet been associated with Lingotek to be
  // translated using Entity Translation's tools.
  if (module_exists('entity_translation')) {
    $translate_path = 'node/%node/translate';
    $lingotek_access_callback = 'lingotek_entity_translation_node_tab_access';
    if (isset($items[$translate_path])) {
      $items[$translate_path]['title'] = 'Translate (Entity Translation)';
      $items[$translate_path]['access callback'] = $lingotek_access_callback;
    }

    $menu_targets = array(
      'node/%node/translate/add/%entity_translation_language/%entity_translation_language',
      'node/%node/translate/delete/%entity_translation_language',
    );

    foreach ($menu_targets as $target) {
      if (isset($items[$target])) {
        $items[$target]['access callback'] = $lingotek_access_callback;
      }
    }

    $edit_target = 'node/%node/translate/edit/%entity_translation_language';
    if (isset($items[$edit_target])) {
      $items[$edit_target]['access callback'] = 'lingotek_entity_translation_edit_access';
      $items[$edit_target]['access arguments'][3] = $lingotek_access_callback;
    }
  }
}

/**
 * Entity Translation access callback when enabled with Lingotek module.
 *
 * @return bool
 *   TRUE if the user should be able to access the requested resource, FALSE otherwise.
 *
 * @see entity_translation_node_tab_access().
 */
function lingotek_entity_translation_node_tab_access() {
  $args = func_get_args();
  $node = array_shift($args);
  if ($node->language != LANGUAGE_NONE) {
    if (lingotek_supported_type($node->type) &&
      !lingotek_lingonode($node->nid, 'create_lingotek_document') &&
      !lingotek_lingonode($node->nid, 'document_id_' . $node->language)) {

      return TRUE;
    }
    elseif (entity_translation_node_supported_type($node->type)) {
      return entity_translation_tab_access('node');
    }
    elseif (entity_translation_node('node', $node)) {
      $function = array_shift($args);
      return call_user_func_array($function, $args);
    }
  }

  return FALSE;
}

/**
 * Entity Translation edit access callback when enabled with Lingotek module.
 *
 * @return bool
 *   TRUE if the user should be able to access the requested resource, FALSE otherwise.
 *
 * @see entity_translation_edit_access()
 */
function lingotek_entity_translation_edit_access($entity_type, $entity, $langcode) {
  $translations = entity_translation_get_handler($entity_type, $entity)->getTranslations();
  // If a translations for the given language does not exist we cannot edit it.
  if (!isset($translations->data[$langcode])) {
    return FALSE;
  }
  // Invoke the actual callback with its arguments.
  $args = func_get_args();
  return call_user_func_array($args[3], array_slice($args, 4));
}

/**
 * Implements hook_permission().
 */
function lingotek_permission() {
  return array(
    'access lingotek utilities' => array(
      'title' => t('Access Lingotek Utilities'),
      'description' => t('Access admin-only utility pages.')
    ),
    'access per-item lingotek project selection' => array(
      'title' => t('Per-item Project Selection'),
      'description' => t('Access the Lingotek Project selector on content creation forms.')
    ),
    'access per-item lingotek vault selection' => array(
      'title' => t('Per-item Vault Selection'),
      'description' => t('Access the Lingotek TM Vault selector on content creation forms.')
    ),
    'administration' => array('title' => 'Administration Menu', 'description' => t('Access the administrative page for the module.')),
    'pm' => array('title' => 'Project Management', 'description' => t('Access the Lingotek tab on content types (Must also have permission to edit the content type in question).')),
    'translation' => array('title' => 'Translate', 'description' => t('Allow access to the workbench for translation (first) phases')),
    'review' => array('title' => 'Review', 'description' => t('Allow access to the workbench for review (following) phases.')),
    'phase_template' => array('title' => 'Phase Template (Workflow)', 'description' => t('Allow node-level setting of the phase template on node creation.  Can only be set once per node.')),
    'use_source' => array('title' => 'Paste Source', 'description' => t('Allow node-level setting of showing the source when no translation is available yet')),
    'sync_method' => array('title' => 'Synchronization Method', 'description' => t('Allow node-level setting of setting the synchronization method')),
    'url_alias_translation' => array('title' => 'URL Alias Translation', 'description' => t('Allow node-level setting of setting the URL alias translation')),
    'mt' => array('title' => 'Machine Translation', 'description' => t('Allow node-level setting of machine translation')),
    'dev' => array('title' => 'Developer', 'description' => t('Access useful debugging features')),
  );
}

/**
 * Implements hook_form_BASE_FORM_ID_alter().
 *
 * @param array $form
 *   A FAPI form array for the form being altered.
 * @param array $form_state
 *   A FAPI form state array for the form being altered.
 * @param string $form_id
 *   The ID of the form being altered.
 */
function lingotek_form_node_form_alter(&$form, $form_state, $form_id) {
  global $_lingotek_locale;

  if (!lingotek_supported_type($form['#node']->type)) {
    return;
  }

  drupal_add_css(drupal_get_path('module', 'lingotek') . '/style/form.css');

  $options = array();
  $options[TRUE] = t('Enabled');
  $options[FALSE] = t('Disabled');

  // Vertical Tab.
  $form['lingotek'] = array(
    '#title' => t('Lingotek Translation Settings'),
    '#type' => 'fieldset',
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'additional_settings',
    '#attributes' => array('id' => array('lingotek_fieldset')),
    '#attached' => array(
      'js' => array(drupal_get_path('module', 'lingotek') . '/js/lingotek.form.js'),
    ),
  );

  $form['lingotek']['note'] = array(
    '#type' => 'item',
    '#title' => t('Lingotek Translation Settings'),
    '#description' => t('Please select a language for Lingotek to use as the source language.  The source language cannot be language neutral.'),
  );

  $form['lingotek']['content'] = array(
    '#type' => 'container',
  );

  $form['lingotek']['content']['note'] = array(
    '#type' => 'item',
    '#title' => t('Lingotek Translation Settings'),
    '#description' => t("The Lingotek Collaborative Translation module was developed by Lingotek to aid administrators of Drupal-created websites in getting their web content translated. The module integrates Lingotek's Collaborative Translation Platform directly into Drupal, so that your users can leverage the power of Lingotek's translation tools without ever having to leave the comfort of their Drupal environment."),
  );

  $node = lingotek_empty_node();
  $document_id = FALSE;
  if (isset($form['nid']['#value'])) {
    $nid = $form['nid']['#value'];
    $node = node_load($nid);
    $document_id = lingotek_lingonode($nid, 'document_id_' . $node->language);
  }

  // Only show these options if the Lingotek document hasn't yet been created.
  if (!$document_id && class_exists('LingotekApi')) {
    $api = LingotekApi::instance();

    // Available projects.
    if ($projects = $api->listProjects()) {
      $form['lingotek']['content']['lingotek_project_id'] = array(
        '#type' => 'select',
        '#title' => 'Project ID',
        '#description' => t('Select the translation project with which this item should be associated.'),
        '#default_value' => variable_get('lingotek_project', ''),
        '#options' => $projects,
        '#access' => user_access('access per-item lingotek project selection'),
      );
    }

    // Translation Memory (TM) Vault.
    if ($vaults = $api->listVaults()) {
      $form['lingotek']['content']['lingotek_vault_id'] = array(
        '#type' => 'select',
        '#title' => t('TM Vault'),
        '#description' => t('Choose the TM vault to associate with this content item.'),
        '#default_value' => variable_get('lingotek_vault', ''),
        '#options' => $vaults,
        '#access' => user_access('access per-item lingotek vault selection'),
      );
    }
    
    // Workflows.
    if ($workflows = $api->listWorkflows()) {
      $form['lingotek']['content']['lingotek_workflow_id'] = array(
        '#type' => 'select',
        '#title' => t('Workflow'),
        '#description' => t('Choose the Workflow to associate with this content item.'),
        '#options' => $workflows,
        '#access' => user_access('access per-item lingotek project selection'),
      );
    }
    
  }

  // Sync Setting.
  $form['lingotek']['content']['syncMethod'] = array(
    '#type' => 'radios',
    '#title' => t('Synchronization Method'),
    '#default_value' => lingotek_variable_get(lingotek_lingonode($node->nid, 'sync_method'), 'lingotek_sync', 100),
    '#options' => lingotek_get_sync_methods(),
    '#access' => user_access('sync_method'),
    '#description' => t("How do you want content on this site to be kept in sync with Lingotek?  Do you want translations to be current and the latest (Always), or only downloaded from Lingotek when done (100%)?  \"Never\" requires you to manually synchronize on the page's Lingotek tab by calling update."),
  );

  // Paste Source Setting.
  $form['lingotek']['content']['useSource'] = array(
    '#type' => 'select',
    '#title' => t('Include source text in synchronization.'),
    '#default_value' => lingotek_variable_get(lingotek_lingonode($node->nid, 'use_source'), 'lingotek_use_source', TRUE),
    '#options' => $options,
    '#access' => user_access('use_source'),
    '#description' => t("This determines if the target languages will fill untranslated text with the source language or simply leave untranslated text out of the document."),
  );

  // Enable auto-push to lingotek.
  $form['lingotek']['content']['create_lingotek_document'] = array(
    '#type' => 'select',
    '#title' => t('Automatically Push Node Content to Lingotek'),
    '#default_value' => lingotek_variable_get(lingotek_lingonode($node->nid, 'create_lingotek_document'), 'lingotek_create_documents_by_default', 1),
    '#options' => array(
      1 => t('Enabled'),
      0 => t('Disabled')
    ),
    '#description' => t("When enabled, this node's content will be pushed to Lingotek when it is created and on every subsequent edit. If you choose not to enable automatic pushes, you can use the 'Push Content' button on this node's Lingotek tab to manually push the contents to Lingotek. (Note: only the content of the source node is pushed to Lingotek, not any existing translations. Also, existing translations will be overwritten when you pull a translation from Lingotek for a given language.)"),
  );

  // URL Alias Translation.
  if (user_access('url_alias_translation')) {
    $form['lingotek']['content']['urlAliasTranslation'] = array
    (
      '#type' => 'radios',
      '#title' => t('URL Alias Translation'),
      '#default_value' => lingotek_variable_get(lingotek_lingonode($node->nid, 'url_alias_translation'), 'lingotek_url_alias_translation', 1),
      '#options' => lingotek_get_url_alias_translations(),
      '#description' => t("Choose how you would like to translate the URL alias. The last option requires that you install both the Title and Pathauto modules, and define a path pattern, and check \"Enable Lingotek Translation\" for the Title field."),
    );
  }
  
  // Community Translation
  $form['lingotek']['content']['lingotek_allow_community_translation'] = array(
    '#type' => 'select',
    '#title' => t('Allow Community Translation'),
    '#description' => t('When enabled, anonymous site visitors will be presented with a link allowing them to contribute translations for this node.'),
    '#options' => array(
      1 => t('Enabled'),
      0 => t('Disabled'),
    ),
    '#default_value' => lingotek_variable_get(lingotek_lingonode($node->nid, 'allow_community_translation'), 'lingotek_allow_community_translation', 0),
  );  

  $form['lingotek']['developer'] = array(
    '#type' => 'fieldset',
    '#title' => t('Developer Settings (Advanced)'),
    '#collapsible' => TRUE,
    '#collapsed' => TRUE,
    '#group' => 'developer_settings',
    '#access' => user_access('dev'),
  );
  if ($document_id === False) {
    $document_id = '';
  }
  $form['lingotek']['developer']['document_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Document Id'),
    '#description' => t("Read/Overwrite the document ID associated with the document.  This can break the translation process but can also be used to help figure out if something is wrong."),
    '#default_value' => $document_id,
  );

  $values = t('None');
  if (isset($nid)) {
    $values = json_encode(lingotek_lingonode($nid));
  }
  $form['lingotek']['developer']['current_lingonode'] = array(
    '#type' => 'item',
    '#title' => t('Node Variables'),
    '#description' => $values,
  );

}

/**
 * Implements hook_node_view().
 */
function lingotek_node_view($node, $view_mode) {
  global $language, $first_load, $user;

  $lingotek_document_id = lingotek_lingonode($node->nid, 'document_id_' . $node->language);
  $community_translation_allowed = lingotek_lingonode($node->nid, 'allow_community_translation');
  if ($view_mode == 'full' && $community_translation_allowed && $lingotek_document_id && lingotek_supported_type($node->type) && lingotek_supported_language($node->language)) {
    drupal_add_css(drupal_get_path('module', 'lingotek') . '/style/base.css');

    // TODO: Is sync on view ever desired behavior?
    lingotek_node_sync($node);

    if (user_is_anonymous() && $language->language != $node->language) {
      $link = lingotek_get_workbench_url($node, $language->language, t('Help make it better.'));
      if ($link != '') {
        $message = t('The translation of @title is still being worked on.', array('@title' => '"' . $node->title . '"')) . " ";
        $message .= $link . '&nbsp;';
        if (lingotek_access($node, 'pm')) {
          $message .= '<span style="font-size: 80%">[' . l(t('progress'), 'node/' . $node->nid . '/lingotek_pm', array('html' => TRUE)) . ']</span>';
        }
        drupal_set_message($message, 'warning', FALSE);
      }
    }
  }
}

function lingotek_node_presave($node) {
  // Make sure the title isn't overwritten with the translation when using the title module.
  if (module_exists('title') && array_key_exists('title_field', $node)) {
    $node->title = $node->title_field[$node->language][0]['value'];
  }
}

/**
 * Implements hook_node_insert().
 */
function lingotek_node_insert($node) {
  lingotek_node_update($node);
}

/**
 * Implements hook_node_update().
 */
function lingotek_node_update($node) {
  // If the user explicitly requested that this item not be pushed to Lingotek, set the Lingonode property so that the
  // edit form default can be set appropriately on subsequent edits.
  if (isset($node->create_lingotek_document)) {
    lingotek_lingonode($node->nid, 'create_lingotek_document', $node->create_lingotek_document);
  }
  else {
    lingotek_lingonode($node->nid, 'create_lingotek_document', 0);
  }
  
  // Only send the node content to Lingotek on edit if Automatic pushes are enabled.
  $send_lingotek_document = (!empty($node->create_lingotek_document) || lingotek_lingonode($node->nid, 'create_lingotek_document'));  

  if (!lingotek_supported_type($node->type) || !lingotek_supported_language($node->language)) {
    return;
  }

  // Overwrite document ID.
  if (user_access('dev') && isset($node->document_id) && is_numeric($node->document_id)) {
    lingotek_lingonode($node->nid, 'document_id_' . $node->language, $node->document_id);
  }
  if (isset($node->mtEngine)) {
    lingotek_lingonode($node->nid, 'mt_engine', $node->mtEngine);
  }
  if (user_access('url_alias_translation') && isset($node->urlAliasTranslation)) {
    lingotek_lingonode($node->nid, 'url_alias_translation', $node->urlAliasTranslation);
  }

  if (isset($node->mtTargets)) {
    $node->mtTargets = array_filter($node->mtTargets, "lingotek_unselected");
    lingotek_lingonode($node->nid, 'mt_targets', implode(",", $node->mtTargets));
  }

  // Items that are only accessible on node add or edit forms for nodes not yet sent to Lingotek.
  if (lingotek_lingonode($node->nid, 'document_id_' . $node->language) === FALSE) {
    lingotek_trace('lingotek_node_update FIRST RUN ONLY', array("nid" => $node->nid, "language" => $node->language));

    $project_id = variable_get('lingotek_project', 0);
    if (user_access('access per-item lingotek project selection') && !empty($node->lingotek_project_id)) {
      $project_id = $node->lingotek_project_id;
    }
    lingotek_lingonode($node->nid, 'project_id', $project_id);

    $vault_id = variable_get('lingotek_vault', '');
    if (user_access('access per-item lingotek vault selection') && !empty($node->lingotek_vault_id)) {
      $vault_id = $node->lingotek_vault_id;
    }
    lingotek_lingonode($node->nid, 'vault_id', $vault_id);
    
    if (!empty($node->lingotek_workflow_id)) {
      lingotek_lingonode($node->nid, 'workflow_id', $node->lingotek_workflow_id);
    }

    if ($send_lingotek_document) {
      if (LingotekApi::instance()->addContentDocument($node)) {
        drupal_set_message(t('<em>@node_title</em> sent to Lingotek successfully.', array('@node_title' => $node->title)));
      }
      else {
        drupal_set_message(t('Unable to send <em>@node_title</em> to Lingotek.', array('@node_title' => $node->title)), 'error');
      }
    }
  }
  else {
    // Keep source document up to date.
    $router_item = menu_get_item();
    if ($send_lingotek_document && $router_item['path'] != 'lingotek/update') {    
      LingotekApi::instance()->updateContentDocument($node);
    }
  }

  if (isset($node->lingotek_allow_community_translation)) {
    lingotek_lingonode($node->nid, 'allow_community_translation', $node->lingotek_allow_community_translation);
  }  

  if (user_access('sync_method') && isset($node->syncMethod)) {
    lingotek_lingonode($node->nid, 'sync_method', $node->syncMethod);
  }
  if (user_access('use_source') && isset($node->useSource)) {
    lingotek_lingonode($node->nid, 'use_source', $node->useSource);
  }

  // Add any missing languages and their phase templates.
  lingotek_add_missing_targets($node);
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Enable Lingotek translation on a node type
 */
function lingotek_form_node_type_form_alter(&$form, &$form_state) {
  $type = $form['#node_type']->type;
  $lingotek_option_label = (module_exists('entity_translation')) ?
    t('Enabled, with Lingotek translation or field translation.'): t('Enabled, with Lingotek translation');
  $form['workflow']['language_content_type']['#options'][LINGOTEK_ENABLED] = $lingotek_option_label;
  $form['workflow']['language_content_type']['#description'] .= ' ' . t('If Lingotek translation is enabled, then it will be possible to use Lingotek\'s collaborative workbench to translate content.');
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Enable Lingotek translation on a field type
 */
function lingotek_form_field_ui_field_edit_form_alter(&$form, &$form_state) {
  if (!lingotek_supported_field_type($form['#field']['type'])) {
    return $form;
  }
  $default = 0;
  if (array_key_exists('lingotek_translatable',  $form['#field'])) {
    $default = $form['#field']['lingotek_translatable'];
  }

  $form['field']['lingotek_translatable'] = array(
    '#type' => 'checkbox',
    '#title' => t('Enable Lingotek Translation'),
    '#description' => t('This allows fields to be translatable using the Lingotek Collaborative Translations Platform.'),
    '#default_value' => $default,
  );
  array_push($form['#submit'], 'lingotek_update_field');
  return $form;
}

function lingotek_update_field($form, $form_state) {
  $field = $form['#field']['field_name'];
  db_update('field_config')->fields(array('translatable' => $form['field']['lingotek_translatable']['#value']))->condition('field_name', $field)->execute();
}


/*
 * hook_help
 */
function lingotek_help($path, $arg) {
  switch ($path) {
    case 'admin/help#lingotek':
      return t('Please see our DevZone:') . ' ' . l(t('Drupal Integration'), 'http://lingotek.com/support/devzone/drupal-integration');
  }
}

/**
 * Batch API processor for field data language updates.
 */
function lingotek_handle_batch_field_language_update($nid, &$context) {
  $process_node = node_load($nid);

  if ($process_node->nid) {
    lingotek_update_language_field_data($process_node->nid);
    $context['message'] = t('Updating field data for node: @node_title', array('@node_title' => $process_node->title));
  }

  $context['finished'] = 1;
}

/**
 * Ensures correct language-specific field data for the specified item.
 *
 * @param int $nid
 *   The node ID of the item to be updated.
 *
 * @return bool
 *   TRUE if the specified node's field data was updated. FALSE if no changes were made.
 */
function lingotek_update_language_field_data($nid) {
  $edited = FALSE;

  $node = node_load($nid, NULL, TRUE);
  if ($node->nid) {
    if ($node->language != 'und') {
      $translatable_fields = lingotek_translatable_node_fields();
      foreach ($translatable_fields as $field_name) {
        if (!empty($node->{$field_name}['und']) && empty($node->{$field_name}[$node->language])) {
          $node->{$field_name}[$node->language] = $node->{$field_name}['und'];
          $edited = TRUE;
        }
      }
    }

    if ($edited) {
      node_save($node);
    }
  }
  else {
    watchdog('lingotek', 'Attempted to update field data for a non-existent node: @node_id',
      array('@node_id' => $node_id), WATCHDOG_ERROR);
  }

  return $edited;
}

/**
 * Gets a list of fields with translation enabled.
 *
 * @return array
 *   An array of the machine names for translatable fields in the system.
 */
function lingotek_translatable_node_fields() {
  $fields = field_info_fields();
  $translatable_fields = array();
  foreach ($fields as $field_id => $field) {
    foreach ($field['bundles'] as $type => $instance) {
      if (field_is_translatable($type, $field)) {
        $translatable_fields[] = $field['field_name'];
      }
    }
  }

  return $translatable_fields;
}

/**
 * "Finished" callback for language update batch operations.
 */
function lingotek_field_language_update_finished($success, $results, $operations) {
  drupal_set_message('Updated field data for nodes.') ;
}

/**
 * Processing callback for the advanced parsing update batch operation.
 */
function lingotek_advanced_parsing_update_node($nid, &$context) {
  $process_node = node_load($nid);

  if (!empty($process_node->nid)) {
    $context['message'] = t('Sending advanced parsing data to Lingotek for node @node_id: @node_title',
      array('@node_id' => $process_node->nid, '@node_title' => $process_node->title));
    if (LingotekApi::instance()->updateContentDocument($process_node)) {
      $context['results'][] = t('Updated node: @id', array('@id' => $process_node->nid));
    }
    else {
      watchdog('lingotek', 'Unable to send advanced XML version of node to Lingotek: @node_id',
        array('@node_id' => $process_node->nid), WATCHDOG_ERROR);
    }
  }
}

/**
 * "Finished" callback for the XML update batch operation.
 */
function lingotek_advanced_parsing_update_finished($success, $results, $operations) {
  if ($success) {
    drupal_set_message(t('Advanced parsing updates complete.'));
  }
  else {
    drupal_set_message(t('There were errors updating one or more existing Lingotek documents.'), 'error');
  }
}

/**
 * Installs the default advanced XML configuration that ships with the module.
 */
function lingotek_install_default_advanced_xml() {
  $filepath_stub = DRUPAL_ROOT . '/' . drupal_get_path('module', 'lingotek') . '/fprm/';
  $config_file_primary = $filepath_stub . 'okf_xmlstream@drupal_filter.fprm';
  $config_file_secondary = $filepath_stub . 'okf_html@drupal_subfilter.fprm';

  if ($config = file_get_contents($config_file_primary)) {
    variable_set('lingotek_advanced_xml_config1', $config);
  }
  else {
    watchdog('lingotek', 'Unable to install default primary advanced XML configuration from: @config_file',
      array('@config_file' => $config_file_primary), WATCHDOG_ERROR);
  }

  if ($config2 = file_get_contents($config_file_secondary)) {
    variable_set('lingotek_advanced_xml_config2', $config2);
  }
  else {
    watchdog('lingotek', 'Unable to install default secondary advanced XML configuration from: @config_file',
      array('@config_file' => $config_file_secondary), WATCHDOG_ERROR);
  }

}

/**
 * Form constructor for the Lingotek Content push form.
 */
function lingotek_content_push_form($form, $form_state, $node) {
  $form = array();
  
  $form['content_push'] = array(
    '#type' => 'fieldset',
    '#title' => t('Push Node Content to Lingotek'),
    '#description' => t("Manually push this node's content to Lingotek"),
    '#collapsible' => TRUE,
    '#collapsed' => FALSE,
  );
  
  $form['content_push']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Push Content'),
  );
  
  $form['node_id'] = array(
    '#type' => 'hidden',
    '#value' => $node->nid,
  );
  
  return $form;
}

/**
 * Submit handler for the lingotek_content_push_form form.
 */
function lingotek_content_push_form_submit($form, $form_state) {
  $node = node_load($form_state['values']['node_id']);
  
  $api = LingotekApi::instance();
  if ($existing_document = lingotek_lingonode($node->nid, 'document_id_' . $node->language)) {
    // Update an existing Lingotek Document.
    $api->updateContentDocument($node);
  }
  else {
    // Create a new Lingotek Document.
    // Add project and vault parameters to the node object.
    $node->lingotek_project_id = lingotek_lingonode($node->nid, 'project_id');
    $node->lingotek_vault_id = lingotek_lingonode($node->nid, 'valut_id');
    $api->addContentDocument($node);
    lingotek_add_missing_targets($node);    
  }
  
  drupal_set_message(t('Pushed content for @node_title to Lingotek for translation.', array('@node_title' => $node->title)));
}
